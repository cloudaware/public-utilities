---
- name: Gather ec2 facts
  action: ec2_facts

- name: ensure custom facts directory exists
  file: path=/etc/ansible/facts.d recurse=yes state=directory mode=0755

- name: install custom fact module
  template: src=templates/upgr_pack.fact.j2 dest=/etc/ansible/facts.d/upgr_pack.fact mode=0755

- name: reload ansible_local
  setup: filter=ansible_local

- name: dump facts to file
  local_action: copy content='{{ hostvars[inventory_hostname] | to_nice_json }}' dest="/tmp/{{ ansible_ec2_instance_id }}.json"

- name: remove long ec2 facts
  local_action: lineinfile dest=/tmp/{{ ansible_ec2_instance_id }}.json regexp='ansible_ec2_metrics_' state=absent

- name: remove unnecessary fields
  local_action: command /usr/local/pre_s3.py /tmp/{{ ansible_ec2_instance_id }}.json

- name: upload facts into s3
  local_action: s3 bucket={{ s3_bucket }} object=/ansible-facts/{{ ansible_ec2_instance_id }}.json src="/tmp/{{ ansible_ec2_instance_id }}.json" mode=put overwrite=True

- name: create cron job
  local_action: template src=templates/ansible_to_s3.j2 dest=/etc/cron.d/ansible_to_s3 mode=0644
